---
class:middle,center,inverse

# Survival plots in Python

---

## Survival data

Survival, or time-to-event, data is common data in biomedical research

We follow subjects over time, and stop either when an event, like death, occurs, or when we stop the study or the subject leaves the study (censoring)

So the response we record are 

1. The time to event or censoring, whichever is earlier
1. Whether we observed the event (1) or the subject was censored (0)

For survival data, we need to install the _lifelines_ and _kaplanmeier_ packages

> You can open the Anaconda console (Win) or a terminal (Mac) and type the following code

```
conda activate biof440
conda install -c conda-forge lifelines
pip install kaplanmeier
```

---

## The Python setup


```python
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
import lifelines as lfl #<<
import kaplanmeier as km #<<
imgdir = 'img'

from IPython.display import IFrame
```

---

## Visualizing survival data

We will first look at the nature of survival data through a visualization. 
We will use some sample data from the _kaplanmeier_ package



```python

df = km.example_data()
time_event = df['time'] # Time to event
censoring = df['Died'] # Whether subject died (1) or was censored (2)
labx = df['group'] # a grouping variable
```


---

## Visualizing survival data

We can plot the subjects' over time, indicating who died (red) and who were censored (blue)

The _lifelines_ package in Python provides most tools for looking at survival data

```python
ax = lfl.plotting.plot_lifetimes(time_event, censoring,
    event_observed_color='red', event_censored_color='blue',
    sort_by_duration=True)
ax.set_xlabel('Time')
ax.vlines(1000, 0,200,linestyles='--');
plt.show()
```
    
![:scale 40%](week5_test_files/week5_test_5_1.png)
    


---
## Survival data

You could look at survival summaries based on this plot, to see how many people died by a certain time

However, to look overall at the survival pattern for this group, we have to account for censoring

The standard way of doing this is using a Kaplan-Meier curve

---

## Kaplan Meier curve in Python

We can compute and plot the Kaplan Meier curve using either the _kaplanmeier_ package or the _lifelines_ package.

---

## Kaplan-Meier curve using _kaplanmeier_

This plot includes a table that tells you how many subjects are at risk, how many are dead,


```python
out = km.fit(time_event, censoring, labx) # Direct grouped lines
km.plot(out)
```


    
![:scale 40%](week5_test_files/week5_test_7_0.png)
    

---
## Kaplan-Meier curve using _lifelines_

We can have greater control over the KM curve using the _lifelines_ package. This package follows the 
coding style of packages like _scikit-learn_ in that we first start a fitting object, then we 
fit the model to the data and then plot it

This plotting uses a matplotlib backend

.pull-left[
```python

from lifelines import KaplanMeierFitter 

kmf = KaplanMeierFitter() # Kaplan Meier fitting object
kmf.fit(time_event, event_observed=censoring) # Fit model to data

kmf.plot(at_risk_counts=False) # No table at first
plt.title('Kaplan-Meier Curve')
plt.show();
```
]
.pull-right[
![](week5_test_files/week5_test_9_0.png)
    
]

---

## Kaplan-Meier curve using _lifelines_

We can clean this curve up a bit.

.pull-left[
```python
ax = kmf.plot()
ax.set_xlabel('days')
ax.set_ylabel('Probability of survival')
ax.get_legend().remove()
ax.set_title('Kaplan-Meier estimates')
plt.show();
```
]
.pull-right[
    
![](week5_test_files/week5_test_11_0.png)
    
]


---

## Kaplan-Meier curve using _lifelines

We can also add the table of deaths below the curve.


```python

ax = kmf.plot( at_risk_counts=True, legend=False)
ax.set_label('days')
ax.set_ylabel('Probability of survival')
plt.show();
```


    
![:scale 50%](week5_test_files/week5_test_13_0.png)
    



---

## Kaplan-Meier curve using _lifelines

We can also add the table of deaths below the curve, even in grouped data

.pull-left[
```python
from lifelines.plotting import add_at_risk_counts

T1 = df.query('group==1')['time']
T2 = df.query('group==2')['time']

C1 = df.query('group==1')['Died']
C2 = df.query('group==2')['Died']

fig, ax = plt.subplots()
kmf1 = KaplanMeierFitter()
kmf1.fit(T1, C1,label='Group 1',)
kmf2 = KaplanMeierFitter()
kmf2.fit(T2, C2,label = 'Group 2',)

ax = kmf1.plot_survival_function(ax = ax,  
  ci_show=False)
ax = kmf2.plot_survival_function(ax = ax, 
  label = 'Group 2', ci_show=False)
add_at_risk_counts(kmf1, kmf2, ax=ax)

plt.tight_layout();
```
]
.pull-right[

    
![](week5_test_files/week5_test_15_0.png)
    
]

---

## Kaplan-Meier curve using _lifelines_

We can also format the axes to show percentages rather than proportions. 

We'll demo this with a single KM curve

.pull-left[
```python
import matplotlib.ticker as mtick

ax = kmf.plot()
ax.set_xlabel('days')
ax.set_ylabel('Probability of survival')
ax.get_legend().remove()
ax.set_title('Kaplan-Meier estimates')
fmt = "%0.0f%%"
ticks = mtick.PercentFormatter(xmax=1, 
    symbol='%', 
    decimals=None) # formats axis as percents
ax.yaxis.set_major_formatter(ticks)
ax.set_ylabel('Percent survived');

plt.tight_layout();
```
]
.pull-right[

    
![](week5_test_files/week5_test_17_0.png)
]
    

